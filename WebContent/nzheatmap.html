<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>新西兰地震数据可视化</title>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
		<link rel="stylesheet" href="../lib/leaflet-dvf/dist/css/dvf.css" />
		<link rel="stylesheet" href="../lib/ext/resources/css/custom.css" />
		<link rel="stylesheet" href="../lib/ext/resources/ext-theme-neptune/ext-theme-neptune-all.css" />
		<link rel="stylesheet" href="../lib/leaflet/leaflet.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../lib/leaflet/leaflet.ie.css" /><![endif]-->
		<!--[if lte IE 8]><link rel="stylesheet" href="responsive-nav.css"><![endif]-->
		<!--[if gt IE 8]><!-->
		<link rel="stylesheet" href="http://www.bootcss.com/p/responsive-nav.js/demo/styles.css">
		<script type="text/javascript" src="../lib/ext/ext-all.js"></script>
		<script src="../lib/leaflet/leaflet-0.6.2-src.js"></script>
		<script type="text/javascript" src="../lib/leaflet/plugin/esri/esri-leaflet/esri-leaflet.js"></script>
		<!--heatmap2里面采用的参数不是lon而是标准的lng-->
		<script type="text/javascript" src="../lib/heatmap/heatmap.js"></script>
		<script type="text/javascript" src="../lib/heatmap/heatmap-leaflet.js"></script>
		<script type="text/javascript" src="../lib/heatmap/QuadTree.js"></script>
		<link rel="stylesheet" href="../lib/leaflet/plugin/MarkerCluster/MarkerCluster.css" />
		<link rel="stylesheet" href="../lib/leaflet/plugin/MarkerCluster/MarkerCluster.Default.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../dist/MarkerCluster.Default.ie.css" /><![endif]-->
		<script src="../lib/leaflet/plugin/MarkerCluster/leaflet.markercluster-src.js"></script>
		<link rel="stylesheet" href="../lib/leaflet/plugin/draw/leaflet.draw.css" />
		<script type="text/javascript" src="../lib/leaflet/plugin/draw/leaflet.draw.js"></script>
		<script type="text/javascript" src="http://makinacorpus.github.io/Leaflet.AlmostOver/Leaflet.GeometryUtil/dist/leaflet.geometryutil.js"></script>
		<script type="text/javascript" src="http://makinacorpus.github.io/Leaflet.AlmostOver/leaflet.almostover.js"></script>
		<link rel="stylesheet" href="../lib/leaflet/plugin/coordinate/Leaflet.Coordinates-0.1.3.css"/>
		<script type="text/javascript" src="../lib/leaflet/plugin/coordinate/Leaflet.Coordinates-0.1.3.min.js"></script>

		<!--<![endif]-->
		<script src="http://www.bootcss.com/p/responsive-nav.js/demo/responsive-nav.js"></script>

		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				height: 100%;
			}
		</style>
	</head>
	<body>
		<div role="navigation" id="nav">
			<ul>
				<li class="active">
					<a href="#">Home</a>
				</li>
			</ul>
		</div>
		<div role="main" class="main">
			<div id='map'></div>
		</div>
		<script>
			Ext.Ajax.disableCaching = false;

			var twitter = function() {

				Ext.Ajax.request({
					//访问node.js从MongoDB中获取的GeoJSON数据
					url : 'http://localhost:3000/earthquake',
					method : 'GET',
					withCredentials : false,
					useDefaultXhrHeader : false,
					success : function(resp, opts) {
						var respText = Ext.JSON.decode(resp.responseText);

						var cloudmade = L.tileLayer('http://{s}.tile.cloudmade.com/{key}/997/256/{z}/{x}/{y}.png', {
							maxZoom : 18,
							attribution : 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
							key : 'BC9A493B41014CAABB98F0471D759707'
						});

						var map = L.map('map').addLayer(cloudmade);
						var heatmapLayer = L.TileLayer.heatMap({
							radius : 20,
							opacity : 0.8,
							gradient : {
								0.45 : "rgb(0,0,255)",
								0.55 : "rgb(0,255,255)",
								0.65 : "rgb(0,255,0)",
								0.95 : "yellow",
								1.0 : "rgb(255,0,0)"
							}
						});
						heatmapLayer.addTo(map);
						array = [];
						respText.features.forEach(function(item) {
							array.push({
								'lat' : item.geometry.coordinates[1],
								'lng' : item.geometry.coordinates[0],
								count : 1
							});
						});
						heatmapLayer.addData(array);
						heatmapLayer.redraw();
						var markers = L.markerClusterGroup();

						var baseballIcon = L.icon({
							iconUrl : '../css/img/Marker-Ball-Pink.png',
							iconSize : [24, 24],
							iconAnchor : [16, 24],
							popupAnchor : [0, -28]
						});

						var geoJsonLayer = L.geoJson(respText, {
							onEachFeature : function(feature, layer) {
								var popupText = "<div style=' max-height:250px;'>";
								popupText += "<b>机构</b>: " + feature.properties.agency + "<br>";
								popupText += "<b>震级</b>: " + feature.properties.magnitude + "<br>";
								popupText += "<b>深度</b>: " + feature.properties.depth + "<br>";
								popupText += "<b>时间</b>: " + feature.properties.updatetime + "<br>";
								popupText += "</div>";
								layer.bindPopup(popupText);
								layer.options.icon = baseballIcon;
							}
						});
						markers.addLayer(geoJsonLayer);

						map.addLayer(markers);
						map.fitBounds(markers.getBounds());
						//编辑工具栏
						var drawnItems = new L.FeatureGroup();
						map.addLayer(drawnItems);

						var drawControl = new L.Control.Draw({
							draw : {
								position : 'topleft',
								polygon : {
									title : 'Draw a sexy polygon!',
									allowIntersection : false,
									drawError : {
										color : '#b00b00',
										timeout : 1000
									},
									shapeOptions : {
										color : '#bada55'
									},
									showArea : true
								},
								polyline : {
									metric : false
								},
								circle : {
									shapeOptions : {
										color : '#662d91'
									}
								}
							},
							edit : {
								featureGroup : drawnItems
							}
						});
						map.addControl(drawControl);

						map.on('draw:created', function(e) {
							var type = e.layerType, layer = e.layer;

							if (type === 'marker') {
								layer.bindPopup('A popup!');
							}

							drawnItems.addLayer(layer);
						});
						//snap
						var lines = L.geoJson({
							type : "FeatureCollection",
							features : [{
								type : "Feature",
								properties : {},
								geometry : {
									type : "LineString",
									coordinates : [[1.3988685607910156, 48.494596878004174], [1.3979887962341309, 48.49458265820301], [1.3975811004638672, 48.49409918258983], [1.397409439086914, 48.49331707992515], [1.3971948623657227, 48.49280515164832], [1.3970017433166504, 48.49222211592656], [1.3965296745300293, 48.49166751475012], [1.396315097808838, 48.49134043941787], [1.396036148071289, 48.49060095697656], [1.3963580131530762, 48.48983302148858], [1.3957571983337402, 48.489705031109914], [1.3952207565307617, 48.48947749186131], [1.3948774337768552, 48.4892499515917], [1.3946199417114258, 48.488993967567986], [1.394383907318115, 48.48853888166857], [1.3941478729248045, 48.48804112678984], [1.3940191268920896, 48.48777091495253], [1.3939118385314941, 48.48741537086776], [1.3943195343017578, 48.48616383585965], [1.3945555686950684, 48.485708724562784], [1.3942551612854002, 48.48539583317714]]
								}
							}, {
								type : "Feature",
								properties : {},
								geometry : {
									type : "LineString",
									coordinates : [[1.3963472843170166, 48.48983302148858], [1.3966315984725952, 48.489783247490834], [1.3977956771850584, 48.48944904938345], [1.398932933807373, 48.489392164379844], [1.3996410369873047, 48.4893495005853], [1.400349140167236, 48.489235730290964], [1.4006924629211426, 48.489548597986165], [1.4010357856750488, 48.49000367482429], [1.4014005661010742, 48.490202769656726], [1.4019370079040525, 48.49017432758567], [1.4039969444274902, 48.489705031109914]]
								}
							}]
						}).addTo(map);

						map.almostOver.addLayer(lines);

						var circle = L.circleMarker([0, 0], {
							radius : 5,
							fillColor : 'white',
							fillOpacity : 1
						});

						map.on('almost:over', function(e) {
							map.addLayer(circle);
							e.layer.setStyle({
								color : 'red'
							});
						});

						map.on('almost:move', function(e) {
							circle.setLatLng(e.latlng);
						});

						map.on('almost:out', function(e) {
							map.removeLayer(circle);
							e.layer.setStyle({
								weight : 5,
								color : '#03f'
							});
						});

						map.on('almost:click', function(e) {
							e.layer.setStyle({
								weight : 10
							});
						});

						//add standard controls
						L.control.coordinates().addTo(map);
						//add configured controls
						L.control.coordinates({
							position : "bottomleft",
							decimals : 2,
							decimalSeperator : ",",
							labelTemplateLat : "Latitude: {y}",
							labelTemplateLng : "Longitude: {x}"
						}).addTo(map);
						L.control.coordinates({
							position : "topright",
							useDMS : true,
							labelTemplateLat : "N {y}",
							labelTemplateLng : "E {x}",
							useLatLngOrder : true
						}).addTo(map);
					},
					failure : function(resp, opts) {
						//alert(resp.responseText);
					}
				});
			};
			twitter();
		</script>

	</body>
</html>