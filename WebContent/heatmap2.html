<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>模仿百万</title>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
		<link rel="stylesheet" href="../lib/leaflet-dvf/dist/css/dvf.css" />
		<link rel="stylesheet" href="../lib/ext/resources/css/custom.css" />
		<link rel="stylesheet" href="../lib/ext/resources/ext-theme-neptune/ext-theme-neptune-all.css" />
		<link rel="stylesheet" href="../lib/leaflet/leaflet.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../lib/leaflet/leaflet.ie.css" /><![endif]-->
		<script type="text/javascript" src="../lib/ext/ext-all.js"></script>
		<script src="../lib/leaflet/leaflet-0.6.2-src.js"></script>
		<script type="text/javascript" src="../lib/leaflet/plugin/esri/esri-leaflet/esri-leaflet.js"></script>
		<!--heatmap2里面采用的参数不是lon而是标准的lng-->
		<script type="text/javascript" src="../lib/heatmap/heatmap.js"></script>
		<script type="text/javascript" src="../lib/heatmap/heatmap-leaflet.js"></script>
		<link rel="stylesheet" href="../lib/leaflet/plugin/MarkerCluster/MarkerCluster.css" />
		<link rel="stylesheet" href="../lib/leaflet/plugin/MarkerCluster/MarkerCluster.Default.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../dist/MarkerCluster.Default.ie.css" /><![endif]-->
		<script src="../lib/leaflet/plugin/MarkerCluster/leaflet.markercluster-src.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				height: 600px;
			}
		</style>
	</head>
	<body>

		<div id='map'></div>
		<script>
			Ext.Ajax.disableCaching = false;
			map = L.map('map').setView([0.0, 0.0], 2);

			L.tileLayer('http://{s}.acetate.geoiq.com/tiles/acetate/{z}/{x}/{y}.png', {
				maxZoom : 18
			}).addTo(map);

			var heatmapLayer = L.TileLayer.heatMap({
				radius : 20,
				opacity : 0.8,
				gradient : {
					0.45 : "rgb(0,0,255)",
					0.55 : "rgb(0,255,255)",
					0.65 : "rgb(0,255,0)",
					0.95 : "yellow",
					1.0 : "rgb(255,0,0)"
				}
			});
			heatmapLayer.addTo(map);

			var markers = L.markerClusterGroup({
				animateAddingMarkers : true
			});
			map.addLayer(markers);

			var twitter = function() {
				ne = map.getBounds().getNorthEast();
				ne = ne["lat"] + "," + ne["lng"];
				sw = map.getBounds().getSouthWest();
				sw = sw["lat"] + "," + sw["lng"];
				zoom = map.getZoom();

				Ext.Ajax.request({
					//访问node.js从MongoDB中获取的GeoJSON数据
					url : 'http://localhost:3000/twitter?ne=' + ne + '&sw=' + sw + '&zoom=' + zoom,
					method : 'GET',
					withCredentials : false,
					useDefaultXhrHeader : false,
					success : function(resp, opts) {
						var respText = Ext.JSON.decode(resp.responseText);

						//heatmapLayer.updateData(respText.points);
						heatmapLayer.addData(respText.points);

						for (var i = 0; i < respText.points.length; i++) {
							//var a = respText.points[i];
							//var m = new L.Marker(new L.LatLng(a["lat"], a["lng"]),{value : a["count"]});
							//markers.addLayer(m);
						}

					},
					failure : function(resp, opts) {
						//alert(resp.responseText);
					}
				});
			};
			setInterval("twitter();", 2000);
			//twitter();
		</script>

	</body>
</html>