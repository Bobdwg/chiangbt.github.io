<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8 />
		<title>模仿百万</title>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
		<link rel="stylesheet" href="../lib/leaflet-dvf/dist/css/dvf.css" />
		<link rel="stylesheet" href="../lib/ext/resources/css/custom.css" />
		<link rel="stylesheet" href="../lib/ext/resources/ext-theme-neptune/ext-theme-neptune-all.css" />
		<link rel="stylesheet" href="../lib/leaflet/leaflet.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../lib/leaflet/leaflet.ie.css" /><![endif]-->
		<script type="text/javascript" src="../lib/ext/ext-all.js"></script>
		<script src="../lib/leaflet/leaflet-0.6.2-src.js"></script>
		<script type="text/javascript" src="../lib/leaflet/plugin/esri/esri-leaflet/esri-leaflet.js"></script>
		<!--heatmap2里面采用的参数不是lon而是标准的lng-->
		<script type="text/javascript" src="../lib/heatmap/heatmap.js"></script>
		<script type="text/javascript" src="../lib/heatmap/heatmap-leaflet.js"></script>
		<script type="text/javascript" src="../lib/heatmap/QuadTree.js"></script>
		<link rel="stylesheet" href="../lib/leaflet/plugin/MarkerCluster/MarkerCluster.css" />
		<link rel="stylesheet" href="../lib/leaflet/plugin/MarkerCluster/MarkerCluster.Default.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="../dist/MarkerCluster.Default.ie.css" /><![endif]-->
		<script src="../lib/leaflet/plugin/MarkerCluster/leaflet.markercluster-src.js"></script>
		<style>
			body {
				margin: 0;
				padding: 0;
			}
			#map {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				height: 100%;
			}
		</style>
	</head>
	<body>

		<div id='map'></div>
		<script>
			Ext.Ajax.disableCaching = false;
			map = L.map('map').setView([0.0, 0.0], 2);

			L.tileLayer('http://{s}.acetate.geoiq.com/tiles/acetate/{z}/{x}/{y}.png', {
				maxZoom : 18
			}).addTo(map);

			var heatmapLayer = L.TileLayer.heatMap({
				radius : 18,
				radiuss : {
					value : 30000,
					absolute : true
				},
				opacity : 0.8,
				gradient : {
					0.45 : "rgb(0,0,255)",
					0.55 : "rgb(0,255,255)",
					0.65 : "rgb(0,255,0)",
					0.95 : "yellow",
					1.0 : "rgb(255,0,0)"
				}
			});
			heatmapLayer.addTo(map);

			var twitter = function() {

				Ext.Ajax.request({
					//访问node.js从MongoDB中获取的GeoJSON数据
					url : 'http://localhost:3000/earthquake',
					method : 'GET',
					withCredentials : false,
					useDefaultXhrHeader : false,
					success : function(resp, opts) {
						var respText = Ext.JSON.decode(resp.responseText);

						array = [];
						respText.features.forEach(function(item) {
							array.push({
								'lat' : item.geometry.coordinates[1],
								'lng' : item.geometry.coordinates[0],
								count : 1
							});
						});
						heatmapLayer.addData(array);
						heatmapLayer.redraw();

						var markers = new L.MarkerClusterGroup({
							//spiderfyOnMaxZoom : false,
							//disableClusteringAtZoom : 7,
							//animateAddingMarkers : true
						});
						
						// 点聚类
						var ms = [];
						for (var i = 0; i < respText.features.length; i++) {
							var a = respText.features[i];
							var m = new L.Marker(new L.LatLng(a.geometry.coordinates[1], a.geometry.coordinates[0]), {
								value : 1
							});
							var popupText = "<div style=' max-height:250px;'>";
							popupText += "<b>区域</b>: " + a.properties.place + "<br>";
							popupText += "<b>震级</b>: " + a.properties.mag + "<br>";
							popupText += "<b>深度</b>: " + a.geometry.coordinates[2] + "<br>";
							popupText += "<b>时间</b>: " + a.properties.time + "<br>";
							popupText += "</div>";
							m.bindPopup(popupText);
							ms.push(m);
							//markers.addLayer(m);
						}
						markers.addLayers(ms);
						map.addLayer(markers);
						
					},
					failure : function(resp, opts) {
						//alert(resp.responseText);
					}
				});
			};
			//setInterval("twitter();", 3000);
			twitter();
		</script>

	</body>
</html>